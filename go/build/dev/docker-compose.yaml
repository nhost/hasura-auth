version: '3.6'
services:
  postgres:
      image: nhost/postgres:14.6-20231218-1
      command:
          - postgres
          - -c
          - config_file=/etc/postgresql.conf
          - -c
          - hba_file=/etc/pg_hba_local.conf
      environment:
          PGDATA: /var/lib/postgresql/data/pgdata
          POSTGRES_DB: local
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
      healthcheck:
          test:
              - CMD-SHELL
              - pg_isready -U postgres
              - -d
              - postgres
              - -q
          timeout: 60s
          interval: 5s
          start_period: 60s
      ports:
          - mode: ingress
            target: 5432
            published: "5432"
            protocol: tcp
      restart: always
      volumes:
          - type: volume
            source: pgdata
            target: /var/lib/postgresql/data/pgdata
            read_only: false
          - type: bind
            source: pg_hba_local.conf
            target: /etc/pg_hba_local.conf
            read_only: true

  graphql-engine:
    image: nhost/graphql-engine:v2.33.4-ce
    depends_on:
      - postgres
    restart: always
    environment:
      HASURA_GRAPHQL_DATABASE_URL: postgres://nhost_hasura@postgres:5432/local
      HASURA_GRAPHQL_JWT_SECRET: '{"key":"0f987876650b4a085e64594fae9219e7781b17506bec02489ad061fba8cb22db","type":"HS256"}'
      HASURA_GRAPHQL_ADMIN_SECRET: nhost-admin-secret
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: public
      HASURA_GRAPHQL_LOG_LEVEL: debug
      HASURA_GRAPHQL_ENABLE_CONSOLE: 'true'
    ports:
      - '8080:8080'

  mailhog:
      image: jcalonso/mailhog:v1.0.1
      environment:
          SMTP_HOST: mailhog
          SMTP_PASS: password
          SMTP_PORT: "1025"
          SMTP_SECURE: "false"
          SMTP_SENDER: hasura-auth@example.com
          SMTP_USER: user
      volumes:
          - type: volume
            source: maildir
            target: /maildir
            read_only: false

volumes:
  pgdata: {}
  maildir: {}

version: '3.6'
services:
  postgres:
    image: nhost/postgres:12-v0.0.5
    restart: always
    volumes:
      - ./db_data/db:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: 'secretpgpassword'
  graphql-engine:
    image: hasura/graphql-engine:v2.0.1
    depends_on:
      - 'postgres'
    restart: always
    environment:
      HASURA_GRAPHQL_ENABLE_CONSOLE: false
      HASURA_GRAPHQL_ADMIN_SECRET: 'hello123'
      HASURA_GRAPHQL_DATABASE_URL: postgres://postgres:secretpgpassword@postgres:5432/postgres
      HASURA_GRAPHQL_ENABLE_CONSOLE: 'true'
      HASURA_GRAPHQL_JWT_SECRET:
        "{\"type\":\"HS256\", \"key\":
        \"5152fa850c02dc222631cca898ed1485821a70912a6e3649c49076912daa3b62182ba013315915d64f40cddfbb8b58eb5bd11ba225336a6af45bbae07ca873f3\"}"
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: public
      HASURA_GRAPHQL_LOG_LEVEL: debug
    ports:
      - '8080:8080'
  hasura-auth:
    container_name: hasura-auth
    image: nhost/hasura-auth:latest
    build:
      context: ../../
      dockerfile: docker/dev/Dockerfile
    command: 'yarn test'
    restart: 'always'
    depends_on:
      - 'graphql-engine'
      - 'mailhog'
    ports:
      - '4000:4000'
    environment:
      NODE_ENV: development
      PORT: 4000
      APP_URL: http://localhost:3000
      SERVER_URL: http://localhost:4000
      DATABASE_URL: postgres://postgres:secretpgpassword@postgres:5432/postgres
      HASURA_GRAPHQL_ADMIN_SECRET: 'hello123'
      HASURA_ENDPOINT: http://graphql-engine:8080/v1/graphql
      JWT_SECRET: 5152fa850c02dc222631cca898ed1485821a70912a6e3649c49076912daa3b62182ba013315915d64f40cddfbb8b58eb5bd11ba225336a6af45bbae07ca873f3
      ANONYMOUS_USERS_ENABLED: 'true'
      EMAILS_ENABLED: 'true'
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      SMTP_PASS: password
      SMTP_USER: user
      SMTP_SECURE: 'false'
      SMTP_SENDER: hbp@hbp.com
      GOOGLE_ENABLED: 'true'
      GOOGLE_CLIENT_ID: '623024459960-4mcq81j0mj6ioqp8col4qo2amq6a8jig.apps.googleusercontent.com'
      GOOGLE_CLIENT_SECRET: 'GpI916QHv-XTnHhF9r9h7Iz3'
      STRAVA_ENABLED: 'true'
      STRAVA_CLIENT_ID: '64535'
      STRAVA_CLIENT_SECRET: '194a968a25ace8adaaa76fb197d1e6b6be5f8aa1'
    volumes:
      - "../../src:/app/src"
      - "../../test:/app/test"
      - "../../types:/app/types"
      - "../../migrations:/app/migrations"
      - "../../tsconfig.json:/app/tsconfig.json"
      - "../../package.json:/app/package.json"
  mailhog:
    image: mailhog/mailhog
    environment:
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      SMTP_PASS: password
      SMTP_USER: user
      SMTP_SECURE: 'false'
      SMTP_SENDER: hbp@hbp.com
    ports:
      - 1025:1025 # smtp server
      - 8025:8025 # web ui
